//dependencies
const fs = require('fs');
const jsonparse = require('jsonparse').parse;



const lib = {};

//base directory of the data folder
const baseDir = `${__dirname}/../.data/`;
const nameFolder = folder => `${baseDir}${folder}/`;
const nameFile = (folder, name) => `${nameFolder(folder)}${name}.json`;

//write

lib.create = function (dir, file, data) {
	return new Promise((resolve, reject) => {

		// create the file for writing (fail if it already exist)
		fs.open(nameFile(dir, file), 'wx', (err, fd) => {
			if (err || !fd) return reject(err);

			// write to it
			fs.writeFile(fd, data, err => {
				if (err) return reject(err);

				// close it
				fs.close(fd, err => {
					if (err) reject(err);
					else resolve(true);
				});
			})
		});
	});
}

//read with promise
lib.read = function (dir, file) {

	return new Promise(function(resolve, reject) {
		fs.readFile(nameFile(dir, file), 'utf8', (err, data) => {
			if (err || !data) reject(err);
			else resolve(jsonparse(data));
		});
	});
}

lib.update = function (dir, file, data) {
	return new Promise(function(resolve, reject) {
		fs.open(nameFile(dir, file), 'r+', (err, fd) => {
			if (err || !fd) return reject(err);

			fs.ftruncate(fd, err => {
				if (err) return reject(err);

				fs.writeFile(fd, data, err => {
					if (err) return reject(err);

					fs.close(fd, err => {
						if (err) reject(err);
						else resolve(true);
					})
				});
			});
		});
	});
}

lib.delete = function (dir, file) {
	return new Promise(function(resolve, reject) {
		fs.unlink(nameFile(dir, file), err => {
			if (err) reject(err);
			resolve(true);
		});
	});
}


lib.list = function (dir) {
	return new Promise(function(resolve, reject) {
		fs.readdir(nameFolder(dir), (err, data) => {
			if (err || !data || data.length === 0) reject(err);
			else resolve(data.map(name => name.replace('.json', '')));
		});
	});
};

module.exports = lib;
